{% extends "base.html" %}

{% block title %}Dashboard Admin{% endblock %}

{% block extra_css %}
<style>
    /* Timer de Rodada */
    #timer-display {
        font-family: 'Courier New', monospace;
        letter-spacing: 0.1em;
        animation: pulse 2s ease-in-out infinite;
    }
    
    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.02); }
    }
    
    #modalTimer .modal-content {
        border: none;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }
    
    #modalTimer .btn-lg {
        font-size: 1.1rem;
        padding: 1rem;
        border-radius: 10px;
        transition: all 0.3s ease;
    }
    
    #modalTimer .btn-lg:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    #modalTimer .btn-lg i {
        font-size: 2rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <h2 class="text-white">
                <i class="bi bi-speedometer2"></i> Dashboard Administrativo
            </h2>
            <p class="text-white-50">Gerencie o jogo e acompanhe o progresso das empresas</p>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="stat-card">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="stat-label">Itera√ß√£o Atual</div>
                        <div class="stat-value" id="iteracao-atual">{{ estatisticas.iteracao_atual }}</div>
                        <small class="text-muted">de {{ estatisticas.max_iteracoes }}</small>
                    </div>
                    <i class="bi bi-calendar-event text-primary" style="font-size: 3rem; opacity: 0.3;"></i>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="stat-card">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="stat-label">Empresas Total</div>
                        <div class="stat-value" id="total-empresas">{{ estatisticas.total_empresas }}</div>
                        <small class="text-success" id="empresas-confirmadas">{{ estatisticas.empresas_confirmadas }} confirmadas</small>
                    </div>
                    <i class="bi bi-building text-success" style="font-size: 3rem; opacity: 0.3;"></i>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="stat-card">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="stat-label">Pendentes</div>
                        <div class="stat-value text-warning" id="empresas-pendentes">{{ estatisticas.empresas_pendentes }}</div>
                        <small class="text-muted">aguardando decis√£o</small>
                    </div>
                    <i class="bi bi-hourglass-split text-warning" style="font-size: 3rem; opacity: 0.3;"></i>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="stat-card">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="stat-label">Lucro M√©dio</div>
                        <div class="stat-value text-success" style="font-size: 1.8rem;">
                            R$ {{ "%.0f"|format(estatisticas.media_lucro) }}
                        </div>
                        <small class="text-muted">entre empresas</small>
                    </div>
                    <i class="bi bi-cash-stack text-success" style="font-size: 3rem; opacity: 0.3;"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Progresso do Jogo -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-bar-chart-fill"></i> Progresso do Jogo
                </div>
                <div class="card-body">
                    <div class="mb-2 d-flex justify-content-between">
                        <span id="label-iteracao">Itera√ß√£o {{ estatisticas.iteracao_atual }} de {{ estatisticas.max_iteracoes }}</span>
                        <span class="fw-bold" id="texto-progresso">{{ "%.1f"|format(estatisticas.progresso) }}%</span>
                    </div>
                    <div class="progress">
                        <div id="barra-progresso" class="progress-bar bg-success" role="progressbar" 
                             style="width: {{ estatisticas.progresso }}%">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Controles -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-gear-fill"></i> Controles do Jogo
                </div>
                <div class="card-body">
                    <div class="row g-2 align-items-center">
                        <!-- Bot√µes Principais - Destaque -->
                        <div class="col-auto">
                            <button id="btnProcessarTurno" class="btn btn-success btn-lg btn-custom {% if not estatisticas.iteracao_aberta %}d-none{% endif %}" onclick="processarTurno()">
                                <i class="bi bi-play-circle"></i> Processar Turno Atual
                            </button>
                            <button id="btnAbrirIteracao" class="btn btn-primary btn-lg btn-custom {% if estatisticas.iteracao_aberta %}d-none{% endif %}" onclick="abrirIteracao()">
                                <i class="bi bi-unlock"></i> Abrir Pr√≥xima Itera√ß√£o
                            </button>
                        </div>
                        <div class="col-auto">
                            <button class="btn btn-info btn-lg btn-custom" onclick="atualizarDashboard()">
                                <i class="bi bi-arrow-clockwise"></i> Atualizar Dashboard
                            </button>
                        </div>
                        
                        <!-- Bot√µes de Otimiza√ß√£o Global -->
                        <div class="col-auto">
                            <div class="btn-group" role="group">
                                <button class="btn btn-outline-info" onclick="calcularOtimoTodas()" title="Calcular solu√ß√£o √≥tima para todas empresas">
                                    <i class="bi bi-percent"></i> Calcular Todas
                                </button>
                                <button class="btn btn-info" onclick="enviarOtimoTodas()" title="Enviar solu√ß√£o √≥tima para todas empresas (podem modificar)">
                                    <i class="bi bi-send-fill"></i> Enviar para Todas
                                </button>
                                <button class="btn btn-warning" onclick="aplicarOtimoTodas()" title="Aplicar e confirmar solu√ß√£o √≥tima em todas empresas (GAP 0%)">
                                    <i class="bi bi-lightning-fill"></i> Aplicar em Todas
                                </button>
                            </div>
                        </div>
                        
                        <!-- Espa√ßador -->
                        <div class="col"></div>
                        
                        <!-- Bot√µes Administrativos - Sutis e Pequenos -->
                        <div class="col-auto">
                            <button class="btn btn-outline-danger btn-lg" onclick="mostrarTimer()" title="Timer de Rodada">
                                <i class="bi bi-stopwatch"></i> Timer
                            </button>
                        </div>
                        <div class="col-auto">
                            <button class="btn btn-outline-primary btn-sm" onclick="mostrarTutorial()" title="Tutorial do Jogo">
                                <i class="bi bi-question-circle"></i> <small>Tutorial</small>
                            </button>
                        </div>
                        <div class="col-auto">
                            <button class="btn btn-outline-info btn-sm" onclick="mostrarModeloMatematico()" title="Ver Modelo Matem√°tico">
                                <i class="bi bi-calculator"></i> <small>Modelo Matem√°tico</small>
                            </button>
                        </div>
                        <div class="col-auto">
                            <button class="btn btn-outline-secondary btn-sm" onclick="confirmarInvalidarSessoes()" title="Deslogar Todos">
                                <i class="bi bi-door-closed"></i> <small>Deslogar</small>
                            </button>
                        </div>
                        <div class="col-auto">
                            <button class="btn btn-outline-warning btn-sm" onclick="confirmarResetarProgresso()" title="Resetar Progresso (Manter Empresas)">
                                <i class="bi bi-arrow-counterclockwise"></i> <small>Reset Progresso</small>
                            </button>
                        </div>
                        <div class="col-auto">
                            <button class="btn btn-outline-danger btn-sm" onclick="confirmarReset()" title="Resetar Jogo Completo">
                                <i class="bi bi-x-circle"></i> <small>Reset Completo</small>
                            </button>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <span id="badge-status-iteracao" class="badge {% if estatisticas.iteracao_aberta %}bg-success{% else %}bg-secondary{% endif %} badge-lg">
                            <i class="bi bi-circle-fill"></i> 
                            <span id="texto-status-iteracao">{% if estatisticas.iteracao_aberta %}Itera√ß√£o Aberta{% else %}Itera√ß√£o Fechada{% endif %}</span>
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gerador de Modelo Default -->
    <!--div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-magic"></i> Gerador de Modelo Default (Otimizador Inverso)
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary mb-3">
                                <i class="bi bi-target"></i> Produ√ß√£o Esperada (Fixar como Constantes)
                            </h6>
                            <div class="row g-2">
                                {% for produto_key, produto_data in produtos.items() %}
                                <div class="col-md-6">
                                    <label class="form-label">{{ produto_data.emoji }} {{ produto_key }}</label>
                                    <input type="number" class="form-control form-control-sm" 
                                           id="producao-{{ produto_key }}" 
                                           value="0" min="0" step="1"
                                           placeholder="Qtd esperada">
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-success mb-3">
                                <i class="bi bi-sliders"></i> Par√¢metros Principais (Otimizar)
                            </h6>
                            <div class="row g-2">
                                <div class="col-md-6">
                                    <label class="form-label">üí∞ Dinheiro Base</label>
                                    <input type="number" class="form-control form-control-sm" 
                                           id="param-dinheiro" 
                                           value="{{ recursos_base.dinheiro }}" 
                                           min="10000" step="1000">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">üì¶ Mat√©ria-Prima</label>
                                    <input type="number" class="form-control form-control-sm" 
                                           id="param-materia" 
                                           value="{{ recursos_base.materia_prima }}" 
                                           min="5000" step="500">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">‚ö° Energia</label>
                                    <input type="number" class="form-control form-control-sm" 
                                           id="param-energia" 
                                           value="{{ recursos_base.energia }}" 
                                           min="5000" step="500">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">üë• Trabalhadores</label>
                                    <input type="number" class="form-control form-control-sm" 
                                           id="param-trabalhadores" 
                                           value="{{ recursos_base.trabalhadores }}" 
                                           min="200" step="50">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <hr class="my-3">
                    
                    <div class="row g-3 align-items-end">
                        <div class="col-md-4">
                            <label class="form-label">Aplicar para:</label>
                            <select class="form-select form-select-sm" id="aplicar-modelo-para">
                                <option value="todas">üåç Todas as Empresas</option>
                                <option value="nova">üÜï Pr√≥ximas Empresas (Default)</option>
                                {% for nome_empresa in empresas.keys() %}
                                <option value="{{ nome_empresa }}">üè¢ {{ nome_empresa }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-8">
                            <div class="btn-group" role="group">
                                <button class="btn btn-primary" onclick="gerarModeloDefault()" id="btnGerarModelo">
                                    <i class="bi bi-magic"></i> Gerar Modelo Otimizado
                                </button>
                                <button class="btn btn-success" onclick="aplicarModeloDefault()" id="btnAplicarModelo" disabled>
                                    <i class="bi bi-check-circle"></i> APLICAR Default
                                </button>
                                <button class="btn btn-outline-secondary" onclick="limparModelo()">
                                    <i class="bi bi-x-circle"></i> Limpar
                                </button>
                            </div>
                        </div>
                    </div-->
                    
                    <!-- Resultado do Modelo -->
                    <!--div id="resultado-modelo" class="mt-3" style="display: none;">
                        <div class="alert alert-info">
                            <h6><i class="bi bi-info-circle"></i> Modelo Gerado:</h6>
                            <div id="detalhes-modelo"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div-->

    <!-- Ranking e Status das Empresas -->
    <div class="row">
        <!-- Ranking -->
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-trophy-fill"></i> Ranking de Empresas
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th width="50">#</th>
                                    <th>Empresa</th>
                                    <th class="text-end">Lucro Total</th>
                                </tr>
                            </thead>
                            <tbody id="rankingTable">
                                {% for empresa in ranking %}
                                <tr>
                                    <td>
                                        {% if loop.index == 1 %}
                                        <i class="bi bi-trophy-fill text-warning"></i>
                                        {% elif loop.index == 2 %}
                                        <i class="bi bi-trophy-fill text-secondary"></i>
                                        {% elif loop.index == 3 %}
                                        <i class="bi bi-trophy-fill" style="color: #cd7f32;"></i>
                                        {% else %}
                                        {{ loop.index }}
                                        {% endif %}
                                    </td>
                                    <td>
                                        <strong>{{ empresa.nome }}</strong>
                                        {% if empresa.equipe %}
                                        <br><small class="text-muted">{{ empresa.equipe }}</small>
                                        {% endif %}
                                    </td>
                                    <td class="text-end">
                                        <span class="badge {% if empresa.lucro_ultimo_turno > 0 %}bg-success{% else %}bg-danger{% endif %}">
                                            R$ {{ "%.2f"|format(empresa.lucro_ultimo_turno) }}
                                        </span>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="3" class="text-center text-muted">Nenhuma empresa cadastrada</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status das Empresas -->
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-building"></i> Status das Empresas</span>
                    <button class="btn btn-sm btn-light" data-bs-toggle="modal" data-bs-target="#modalNovaEmpresa">
                        <i class="bi bi-plus-circle"></i> Nova Empresa
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover table-sm">
                            <thead>
                                <tr>
                                    <th>Empresa</th>
                                    <th class="text-center">Status</th>
                                    <th class="text-center">GAP%</th>
                                    <th class="text-center">A√ß√£o</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for nome, empresa in empresas.items() %}
                                <tr data-empresa="{{ nome }}" class="empresa-row">
                                    <td>
                                        <strong>{{ nome }}</strong>
                                        <br><small class="text-muted">√öltima: R$ <span class="lucro-ultima">{{ "%.2f"|format(empresa.get('lucro_ultimo_turno', 0)) }}</span></small>
                                    </td>
                                    <td class="text-center">
                                        {% if empresa.decisao_confirmada %}
                                        <span class="badge bg-success badge-status">
                                            <i class="bi bi-check-circle"></i> Confirmada
                                        </span>
                                        {% else %}
                                        <span class="badge bg-warning badge-status">
                                            <i class="bi bi-clock"></i> Pendente
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if empresa.get('gap_percentual') is not none %}
                                        <span class="badge gap-badge" 
                                              style="background-color: {% if empresa.gap_percentual <= 5 %}#28a745{% elif empresa.gap_percentual <= 20 %}#ffc107{% else %}#dc3545{% endif %};">
                                            <span class="gap-valor">{{ "%.1f"|format(empresa.gap_percentual) }}%</span>
                                        </span>
                                        {% else %}
                                        <small class="text-muted">-</small>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group btn-group-sm mb-1" role="group">
                                            <button class="btn btn-outline-info btn-calcular-gap" onclick="calcularGap('{{ nome }}')" title="Calcular GAP% (sem mostrar solu√ß√£o)">
                                                <i class="bi bi-percent"></i>
                                            </button>
                                            <button class="btn btn-outline-success" onclick="calcularOtimo('{{ nome }}')" title="Calcular e Mostrar Solu√ß√£o √ìtima">
                                                <i class="bi bi-calculator"></i>
                                            </button>
                                            <button class="btn btn-info" onclick="enviarOtimo('{{ nome }}')" title="Enviar √ìtimo para Empresa (pode modificar)">
                                                <i class="bi bi-send"></i>
                                            </button>
                                            <button class="btn btn-success" onclick="aplicarOtimo('{{ nome }}')" title="Aplicar e Confirmar √ìtimo (GAP 0%)">
                                                <i class="bi bi-lightning-fill"></i>
                                            </button>
                                        </div>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button class="btn btn-outline-primary" onclick="acessarComoEmpresa('{{ nome }}')" title="Acessar como usu√°rio">
                                                <i class="bi bi-box-arrow-in-right"></i>
                                            </button>
                                            <button class="btn btn-outline-warning" onclick="alterarSenhaEmpresa('{{ nome }}')" title="Alterar senha">
                                                <i class="bi bi-key"></i>
                                            </button>
                                            <button class="btn btn-outline-danger" onclick="removerEmpresa('{{ nome }}')" title="Remover">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="3" class="text-center text-muted">Nenhuma empresa cadastrada</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gr√°fico de Evolu√ß√£o -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-graph-up"></i> Evolu√ß√£o dos Lucros
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="chartLucros"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gerenciamento de Saves -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-secondary">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-floppy"></i> <small>Gerenciamento de Saves</small></span>
                    <button class="btn btn-sm btn-outline-secondary" onclick="atualizarListaSaves()">
                        <i class="bi bi-arrow-clockwise"></i> Atualizar
                    </button>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-2">
                            <button class="btn btn-success btn-sm w-100" onclick="salvarJogo()">
                                <i class="bi bi-floppy"></i> Salvar
                            </button>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-info btn-sm w-100" data-bs-toggle="modal" data-bs-target="#modalSaves">
                                <i class="bi bi-folder-open"></i> Carregar
                            </button>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-primary btn-sm w-100" onclick="$('#inputUploadSave').click()">
                                <i class="bi bi-upload"></i> Upload
                            </button>
                            <input type="file" id="inputUploadSave" accept=".json" style="display: none;" onchange="uploadSave(this)">
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-warning btn-sm w-100" onclick="confirmarExcluirTodosSaves()">
                                <i class="bi bi-trash"></i> Excluir Todos
                            </button>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="autoSaveToggle" onchange="toggleAutoSave()">
                                <label class="form-check-label" for="autoSaveToggle">
                                    <small><i class="bi bi-save"></i> Auto-save ap√≥s cada itera√ß√£o</small>
                                </label>
                            </div>
                            <div class="alert alert-info mb-0 py-1 mt-2">
                                <small><i class="bi bi-info-circle"></i> Total de saves: <strong id="total-saves">0</strong></small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Nova Empresa -->
<div class="modal fade" id="modalNovaEmpresa" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-plus-circle"></i> Adicionar Nova Empresa
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formNovaEmpresa">
                    <div class="mb-3">
                        <label for="nomeEmpresa" class="form-label">Nome da Empresa</label>
                        <input type="text" class="form-control" id="nomeEmpresa" required>
                    </div>
                    <div class="mb-3">
                        <label for="equipeEmpresa" class="form-label">Nome da Equipe</label>
                        <input type="text" class="form-control" id="equipeEmpresa">
                    </div>
                    <div class="mb-3">
                        <label for="senhaEmpresa" class="form-label">Senha de Acesso</label>
                        <input type="text" class="form-control" id="senhaEmpresa" required>
                        <div class="form-text">Os alunos usar√£o esta senha para fazer login</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="criarEmpresa()">Criar Empresa</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Gerenciamento de Saves -->
<div class="modal fade" id="modalSaves" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-folder-open"></i> Carregar Save
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Data do Save</th>
                                <th>Empresas</th>
                                <th>Itera√ß√£o</th>
                                <th class="text-center">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="listaSaves">
                            <tr>
                                <td colspan="5" class="text-center text-muted">
                                    <i class="bi bi-hourglass-split"></i> Carregando...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Resultado Otimiza√ß√£o -->
<div class="modal fade" id="modalOtimizacao" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="bi bi-calculator"></i> Resultado da Otimiza√ß√£o
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="resultadoOtimizacao" class="font-monospace" style="white-space: pre-wrap;">
                    <i class="bi bi-hourglass-split"></i> Calculando...
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Gr√°fico de evolu√ß√£o
    let chartLucros = null;
    
    function inicializarGrafico() {
        const ctx = document.getElementById('chartLucros');
        if (!ctx) return;
        
        chartLucros = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: []
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return 'R$ ' + value.toLocaleString('pt-BR');
                            }
                        }
                    }
                }
            }
        });
        
        atualizarGrafico();
    }
    
    function atualizarGrafico() {
        // Buscar dados via API
        $.get('/api/ranking', function(empresas) {
            if (!chartLucros) return;
            
            const cores = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c'];
            const datasets = [];
            let maxTurnos = 0;
            
            // Filtrar apenas empresas com hist√≥rico
            const empresasComHistorico = empresas.filter(e => e.historico_lucros && e.historico_lucros.turnos && e.historico_lucros.turnos.length > 0);
            
            if (empresasComHistorico.length === 0) {
                // Se n√£o h√° hist√≥rico, mostrar gr√°fico vazio
                chartLucros.data.labels = [];
                chartLucros.data.datasets = [];
                chartLucros.update();
                return;
            }
            
            empresasComHistorico.forEach((empresa, idx) => {
                const historico = empresa.historico_lucros;
                const turnos = historico.turnos || [];
                const valores = historico.valores || [];
                
                if (turnos.length > maxTurnos) {
                    maxTurnos = turnos.length;
                    chartLucros.data.labels = turnos.map(t => 'Turno ' + t);
                }
                
                datasets.push({
                    label: empresa.nome,
                    data: valores,
                    borderColor: cores[idx % cores.length],
                    backgroundColor: cores[idx % cores.length] + '33',
                    borderWidth: 2,
                    tension: 0.3,
                    pointRadius: 4,
                    pointHoverRadius: 6
                });
            });
            
            chartLucros.data.datasets = datasets;
            chartLucros.update();
        }).fail(function() {
            console.error('Erro ao buscar dados do gr√°fico');
        });
    }
    
    function atualizarDadosAdmin() {
        atualizarListaEmpresas();
        atualizarGrafico();
    }

    function processarTurno() {
        if (!confirm('Processar turno atual? Isso aplicar√° todas as decis√µes confirmadas.')) {
            return;
        }
        
        showLoading();
        ajaxSeguro('{{ url_for("admin.processar_turno") }}', {
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({})
        }).done(function(response) {
            hideLoading();
            if (response.sucesso) {
                showToast('Turno processado com sucesso!', 'success');
                atualizarDadosAdmin();
            } else {
                showToast(response.mensagem || 'Erro ao processar turno', 'danger');
            }
        }).fail(function(xhr) {
            hideLoading();
            const msg = xhr.responseJSON?.mensagem || 'Erro ao processar turno';
            showToast(msg, 'danger');
        });
    }
    
    function abrirIteracao() {
        showLoading();
        ajaxSeguro('{{ url_for("admin.abrir_iteracao") }}', {
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({})
        }).done(function(response) {
            hideLoading();
            if (response.sucesso) {
                showToast('Itera√ß√£o aberta para envio de decis√µes!', 'success');
                atualizarDadosAdmin();
            } else {
                showToast('Erro ao abrir itera√ß√£o', 'danger');
            }
        }).fail(function(xhr) {
            hideLoading();
            const msg = xhr.responseJSON?.mensagem || 'Erro ao abrir itera√ß√£o';
            showToast(msg, 'danger');
        });
    }
    
    function confirmarResetarProgresso() {
        if (!confirm('Resetar apenas o progresso do jogo?\n\nAs empresas cadastradas ser√£o MANTIDAS, mas todo hist√≥rico, lucros e itera√ß√µes ser√£o zerados.\n\nTodas as empresas precisar√£o fazer login novamente.')) {
            return;
        }
        
        showLoading();
        ajaxSeguro('{{ url_for("admin.resetar_progresso") }}', {
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({})
        }).done(function(response) {
            hideLoading();
            if (response.sucesso) {
                showToast(response.mensagem || 'Progresso resetado!', 'success');
                atualizarDadosAdmin();
            } else {
                showToast('Erro ao resetar progresso', 'danger');
            }
        }).fail(function(xhr) {
            hideLoading();
            const msg = xhr.responseJSON?.mensagem || 'Erro ao resetar progresso';
            showToast(msg, 'danger');
        });
    }
    
    function confirmarReset() {
        if (!confirm('ATEN√á√ÉO: Isso ir√° resetar o jogo COMPLETAMENTE!\n\nTODAS as empresas cadastradas ser√£o REMOVIDAS permanentemente.\n\nTodo hist√≥rico, dados e configura√ß√µes ser√£o apagados.\n\nConfirma?')) {
            return;
        }
        
        showLoading();
        ajaxSeguro('{{ url_for("admin.resetar_jogo") }}', {
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({})
        }).done(function(response) {
            hideLoading();
            if (response.sucesso) {
                showToast('Jogo resetado com sucesso!', 'success');
                atualizarDadosAdmin();
            } else {
                showToast('Erro ao resetar jogo', 'danger');
            }
        }).fail(function(xhr) {
            hideLoading();
            const msg = xhr.responseJSON?.mensagem || 'Erro ao resetar jogo';
            showToast(msg, 'danger');
        });
    }
    
    function confirmarInvalidarSessoes() {
        if (!confirm('Deslogar todas as empresas?\n\nIsso for√ßar√° todos os alunos a fazer login novamente.')) {
            return;
        }
        
        showLoading();
        ajaxSeguro('{{ url_for("admin.invalidar_sessoes") }}', {
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({})
        }).done(function(response) {
            hideLoading();
            if (response.sucesso) {
                showToast(response.mensagem || 'Todas as sess√µes foram invalidadas!', 'success');
            } else {
                showToast('Erro ao invalidar sess√µes', 'danger');
            }
        }).fail(function(xhr) {
            hideLoading();
            const msg = xhr.responseJSON?.mensagem || 'Erro ao invalidar sess√µes';
            showToast(msg, 'danger');
        });
    }
    
    function criarEmpresa() {
        const nome = $('#nomeEmpresa').val();
        const equipe = $('#equipeEmpresa').val();
        const senha = $('#senhaEmpresa').val();
        
        if (!nome || !senha) {
            showToast('Preencha todos os campos obrigat√≥rios', 'warning');
            return;
        }
        
        showLoading();
        ajaxSeguro('/api/admin/criar-empresa', {
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({nome, equipe, senha})
        }).done(function(response) {
            hideLoading();
            if (response.sucesso) {
                showToast(response.mensagem, 'success');
                $('#modalNovaEmpresa').modal('hide');
                // Limpar formul√°rio
                $('#nomeEmpresa, #equipeEmpresa, #senhaEmpresa').val('');
                atualizarDadosAdmin();
            } else {
                showToast(response.mensagem, 'danger');
            }
        }).fail(function(xhr) {
            hideLoading();
            const msg = xhr.responseJSON?.mensagem || 'Erro ao criar empresa';
            showToast(msg, 'danger');
        });
    }
    
    function acessarComoEmpresa(nome) {
        if (confirm(`Acessar o sistema como "${nome}"?\n\nVoc√™ ser√° redirecionado para o dashboard do aluno.`)) {
            window.location.href = `/admin/acessar-como-empresa/${encodeURIComponent(nome)}`;
        }
    }
    
    function alterarSenhaEmpresa(nome) {
        const novaSenha = prompt(`Alterar senha da empresa "${nome}":\n\nDigite a nova senha:`);
        
        if (!novaSenha) {
            return;
        }
        
        if (novaSenha.length < 3) {
            showToast('Senha deve ter pelo menos 3 caracteres', 'warning');
            return;
        }
        
        showLoading();
        ajaxSeguro('/admin/alterar-senha-empresa', {
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                nome_empresa: nome,
                nova_senha: novaSenha
            })
        }).done(function(response) {
            hideLoading();
            if (response.sucesso) {
                showToast(`Senha de "${nome}" alterada com sucesso!`, 'success');
            } else {
                showToast(response.mensagem, 'danger');
            }
        }).fail(function(xhr) {
            hideLoading();
            const msg = xhr.responseJSON?.mensagem || 'Erro ao alterar senha';
            showToast(msg, 'danger');
        });
    }
    
    function removerEmpresa(nome) {
        if (!confirm(`Remover empresa "${nome}"?\n\nEsta a√ß√£o n√£o pode ser desfeita!`)) {
            return;
        }
        
        showLoading();
        ajaxSeguro(`/api/admin/remover-empresa/${encodeURIComponent(nome)}`, {
            method: 'DELETE'
        }).done(function(response) {
            hideLoading();
            if (response.sucesso) {
                showToast('Empresa removida com sucesso!', 'success');
                atualizarDadosAdmin();
            } else {
                showToast(response.mensagem, 'danger');
            }
        }).fail(function(xhr) {
            hideLoading();
            const msg = xhr.responseJSON?.mensagem || 'Erro ao remover empresa';
            showToast(msg, 'danger');
        });
    }
    
    function atualizarDashboard() {
        showToast('Atualizando dados...', 'info');
        atualizarDadosAdmin();
    }
    
    function calcularOtimo(nomeEmpresa) {
        showLoading();
        $('#resultadoOtimizacao').html('<i class="bi bi-hourglass-split"></i> Calculando solu√ß√£o √≥tima...');
        $('#modalOtimizacao').modal('show');
        
        ajaxSeguro(`/admin/api/otimizar/${encodeURIComponent(nomeEmpresa)}`, {
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({})
        }).done(function(response) {
            hideLoading();
            if (response.sucesso) {
                const texto = response.texto_legivel || JSON.stringify(response, null, 2);
                $('#resultadoOtimizacao').html(texto);
            } else {
                const mensagem = response.mensagem || 'Erro ao calcular solu√ß√£o √≥tima';
                $('#resultadoOtimizacao').html(`‚ùå ${mensagem}`);
                showToast(mensagem, 'danger');
            }
        }).fail(function(xhr) {
            hideLoading();
            const msg = xhr.responseJSON?.mensagem || 'Erro ao calcular otimiza√ß√£o';
            $('#resultadoOtimizacao').html(`‚ùå ${msg}`);
            showToast(msg, 'danger');
        });
    }
    
    function enviarOtimo(nomeEmpresa) {
        if (!confirm(`Enviar solu√ß√£o √≥tima para "${nomeEmpresa}"?\n\nOs valores ser√£o preenchidos na tela da empresa, mas ela poder√° modificar antes de confirmar.`)) {
            return;
        }
        
        showLoading();
        ajaxSeguro(`/admin/api/enviar-otimizacao/${encodeURIComponent(nomeEmpresa)}`, {
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({})
        }).done(function(response) {
            hideLoading();
            if (response.sucesso) {
                showToast(response.mensagem, 'success');
                
                // Mostrar detalhes em modal (opcional)
                if (response.texto_legivel) {
                    $('#resultadoOtimizacao').html(response.texto_legivel);
                    $('#modalOtimizacao').modal('show');
                }
                
                // Atualizar dashboard
                atualizarDadosAdmin();
            } else {
                showToast(response.mensagem || 'Erro ao enviar otimiza√ß√£o', 'danger');
            }
        }).fail(function(xhr) {
            hideLoading();
            const msg = xhr.responseJSON?.mensagem || 'Erro ao enviar otimiza√ß√£o';
            showToast(msg, 'danger');
        });
    }
    
    function aplicarOtimo(nomeEmpresa) {
        if (!confirm(`‚ö° APLICAR E CONFIRMAR solu√ß√£o √≥tima para "${nomeEmpresa}"?\n\nIsso substituir√° e CONFIRMAR√Å a decis√£o atual da empresa pela melhor solu√ß√£o poss√≠vel.\nA empresa N√ÉO poder√° modificar.`)) {
            return;
        }
        
        showLoading();
        ajaxSeguro(`/admin/api/aplicar-otimizacao/${encodeURIComponent(nomeEmpresa)}`, {
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({})
        }).done(function(response) {
            hideLoading();
            if (response.sucesso) {
                showToast(response.mensagem, 'success');
                
                // Mostrar detalhes em modal
                if (response.texto_legivel) {
                    $('#resultadoOtimizacao').html(response.texto_legivel);
                    $('#modalOtimizacao').modal('show');
                }
                
                // Atualizar dashboard
                atualizarDadosAdmin();
            } else {
                showToast(response.mensagem || 'Erro ao aplicar otimiza√ß√£o', 'danger');
            }
        }).fail(function(xhr) {
            hideLoading();
            const msg = xhr.responseJSON?.mensagem || 'Erro ao aplicar otimiza√ß√£o';
            showToast(msg, 'danger');
        });
    }
    
    function calcularGap(nomeEmpresa) {
        showLoading();
        ajaxSeguro(`/admin/api/calcular-otimo-sem-mostrar/${encodeURIComponent(nomeEmpresa)}`, {
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({})
        }).done(function(response) {
            hideLoading();
            if (response.sucesso) {
                // Mostrar apenas GAP% (n√£o mostrar lucro √≥timo)
                showToast(`GAP%: ${response.gap_percentual.toFixed(1)}% (√öltima: R$ ${response.lucro_atual.toFixed(2)})`, 'info');
                
                // Atualizar linha da empresa na tabela
                const $row = $(`.empresa-row[data-empresa="${nomeEmpresa}"]`);
                
                // Atualizar GAP badge
                const gap = response.gap_percentual;
                let bgColor = '#dc3545';  // Vermelho (>20%)
                if (gap <= 5) bgColor = '#28a745';  // Verde (‚â§5%)
                else if (gap <= 20) bgColor = '#ffc107';  // Amarelo (‚â§20%)
                
                $row.find('.gap-badge').css('background-color', bgColor);
                $row.find('.gap-valor').text(gap.toFixed(1) + '%');
                
                // Atualizar lucro √∫ltima itera√ß√£o
                $row.find('.lucro-ultima').text(response.lucro_atual.toFixed(2));
            } else {
                showToast(response.mensagem || 'Erro ao calcular GAP', 'danger');
            }
        }).fail(function(xhr) {
            hideLoading();
            const msg = xhr.responseJSON?.mensagem || 'Erro ao calcular GAP';
            showToast(msg, 'danger');
        });
    }
    
    function calcularOtimoTodas() {
        if (!confirm('Calcular solu√ß√£o √≥tima para TODAS as empresas?\n\nIsso calcular√° o lucro m√°ximo poss√≠vel para cada empresa.')) {
            return;
        }
        
        showLoading();
        ajaxSeguro('/admin/api/calcular-otimo-todas', {
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({})
        }).done(function(response) {
            hideLoading();
            if (response.sucesso) {
                showToast(response.mensagem, 'success');
                
                // Atualizar dashboard para mostrar GAPs
                atualizarDadosAdmin();
            } else {
                showToast('Erro ao calcular otimiza√ß√£o para todas empresas', 'danger');
            }
        }).fail(function(xhr) {
            hideLoading();
            const msg = xhr.responseJSON?.mensagem || 'Erro ao calcular otimiza√ß√£o global';
            showToast(msg, 'danger');
        });
    }
    
    function enviarOtimoTodas() {
        if (!confirm('üì§ ENVIAR SOLU√á√ÉO √ìTIMA PARA TODAS AS EMPRESAS?\n\nOs valores ser√£o preenchidos nas telas de todas as empresas.\nCada empresa poder√° modificar antes de confirmar.')) {
            return;
        }
        
        showLoading();
        ajaxSeguro('/admin/api/enviar-otimo-todas', {
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({})
        }).done(function(response) {
            hideLoading();
            if (response.sucesso) {
                showToast(`‚úÖ ${response.mensagem}`, 'info');
                
                // Atualizar dashboard
                atualizarDadosAdmin();
            } else {
                showToast('Erro ao enviar otimiza√ß√£o para todas empresas', 'danger');
            }
        }).fail(function(xhr) {
            hideLoading();
            const msg = xhr.responseJSON?.mensagem || 'Erro ao enviar otimiza√ß√£o global';
            showToast(msg, 'danger');
        });
    }
    
    function aplicarOtimoTodas() {
        if (!confirm('‚ö° APLICAR E CONFIRMAR SOLU√á√ÉO √ìTIMA EM TODAS AS EMPRESAS? ‚ö°\n\nIsso substituir√° e CONFIRMAR√Å as decis√µes de TODAS as empresas pela solu√ß√£o √≥tima (GAP 0%).\n\nAs empresas N√ÉO poder√£o modificar.\nTodas ter√£o lucro m√°ximo!')) {
            return;
        }
        
        showLoading();
        ajaxSeguro('/admin/api/aplicar-otimo-todas', {
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({})
        }).done(function(response) {
            hideLoading();
            if (response.sucesso) {
                showToast(`‚úÖ ${response.mensagem}`, 'success');
                
                // Atualizar dashboard
                atualizarDadosAdmin();
            } else {
                showToast('Erro ao aplicar otimiza√ß√£o para todas empresas', 'danger');
            }
        }).fail(function(xhr) {
            hideLoading();
            const msg = xhr.responseJSON?.mensagem || 'Erro ao aplicar otimiza√ß√£o global';
            showToast(msg, 'danger');
        });
    }
    
    function atualizarControlesJogo(status) {
        if (!status) return;
        const iteracaoAtual = status.iteracao_atual || 0;
        const maxIteracoes = status.max_iteracoes || 0;
        const progresso = Number(status.progresso) || 0;
        const progressoAjustado = Math.max(0, Math.min(progresso, 100));
        const jogoFinalizado = iteracaoAtual > maxIteracoes;
        const iteracaoAberta = !!status.iteracao_aberta && !jogoFinalizado;

        $('#iteracao-atual').text(iteracaoAtual);
        $('#label-iteracao').text(`Itera√ß√£o ${iteracaoAtual} de ${maxIteracoes}`);
        $('#texto-progresso').text(`${progresso.toFixed(1)}%`);
        $('#barra-progresso').css('width', `${progressoAjustado}%`);

        if (jogoFinalizado) {
            $('#btnProcessarTurno, #btnAbrirIteracao').addClass('d-none').prop('disabled', true);
            $('#badge-status-iteracao')
                .removeClass('bg-success')
                .addClass('bg-secondary');
            $('#texto-status-iteracao').text('Jogo Finalizado');
            return;
        }

        if (iteracaoAberta) {
            $('#btnProcessarTurno').removeClass('d-none').prop('disabled', false);
            $('#btnAbrirIteracao').addClass('d-none');
            $('#badge-status-iteracao')
                .removeClass('bg-secondary')
                .addClass('bg-success');
            $('#texto-status-iteracao').text('Itera√ß√£o Aberta');
        } else {
            $('#btnProcessarTurno').addClass('d-none');
            $('#btnAbrirIteracao').removeClass('d-none').prop('disabled', false);
            $('#badge-status-iteracao')
                .removeClass('bg-success')
                .addClass('bg-secondary');
            $('#texto-status-iteracao').text('Itera√ß√£o Fechada');
        }
    }

    // AJAX: Atualizar lista de empresas e estat√≠sticas automaticamente
    function atualizarListaEmpresas() {
        $.get('/api/ranking', function(empresas) {
            // Atualizar contadores
            $('#total-empresas').text(empresas.length);
            
            let confirmadas = empresas.filter(e => e.decisao_confirmada).length;
            let pendentes = empresas.length - confirmadas;
            
            $('#empresas-confirmadas').text(confirmadas + ' confirmadas');
            $('#empresas-pendentes').text(pendentes);
            
            // Verificar se h√° mudan√ßa no n√∫mero de empresas (nova empresa ou remo√ß√£o)
            const linhasAtuais = $('tr[data-empresa]').length;
            const empresasNoRanking = empresas.length;
            
            if (linhasAtuais !== empresasNoRanking) {
                // RECONSTRUIR TABELA DE RANKING
                const rankingTbody = $('#rankingTable');
                rankingTbody.empty();
                
                if (empresas.length === 0) {
                    rankingTbody.append('<tr><td colspan="3" class="text-center text-muted">Nenhuma empresa cadastrada</td></tr>');
                } else {
                    empresas.forEach(function(empresa, index) {
                        let medalha = '';
                        if (index === 0) medalha = '<i class="bi bi-trophy-fill text-warning"></i>';
                        else if (index === 1) medalha = '<i class="bi bi-trophy-fill text-secondary"></i>';
                        else if (index === 2) medalha = '<i class="bi bi-trophy-fill" style="color: #cd7f32;"></i>';
                        else medalha = index + 1;
                        
                        const lucroClass = empresa.lucro_ultimo_turno > 0 ? 'bg-success' : 'bg-danger';
                        
                        const rowRanking = `
                            <tr>
                                <td>${medalha}</td>
                                <td>
                                    <strong>${empresa.nome}</strong>
                                    ${empresa.equipe ? '<br><small class="text-muted">' + empresa.equipe + '</small>' : ''}
                                </td>
                                <td class="text-end">
                                    <span class="badge ${lucroClass}">R$ ${empresa.lucro_ultimo_turno.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                                </td>
                            </tr>
                        `;
                        rankingTbody.append(rowRanking);
                    });
                }
                
                // RECONSTRUIR TABELA DE STATUS
                const statusTbody = $('table.table-hover.table-sm tbody');
                statusTbody.empty();
                
                if (empresas.length === 0) {
                    statusTbody.append('<tr><td colspan="3" class="text-center text-muted">Nenhuma empresa cadastrada</td></tr>');
                } else {
                    empresas.forEach(function(empresa) {
                        const statusClass = empresa.decisao_confirmada ? 'bg-success' : 'bg-warning';
                        const statusIcon = empresa.decisao_confirmada ? 'check-circle' : 'clock';
                        const statusText = empresa.decisao_confirmada ? 'Confirmada' : 'Pendente';
                        
                        // GAP%
                        let gapHtml = '<small class="text-muted">-</small>';
                        if (empresa.gap_percentual != null) {
                            let gapColor = '#dc3545'; // Vermelho
                            if (empresa.gap_percentual <= 5) gapColor = '#28a745'; // Verde
                            else if (empresa.gap_percentual <= 20) gapColor = '#ffc107'; // Amarelo
                            gapHtml = `<span class="badge gap-badge" style="background-color: ${gapColor};"><span class="gap-valor">${empresa.gap_percentual.toFixed(1)}%</span></span>`;
                        }
                        
                        const rowStatus = `
                            <tr data-empresa="${empresa.nome}" class="empresa-row">
                                <td>
                                    <strong>${empresa.nome}</strong>
                                    <br><small class="text-muted">√öltima: R$ <span class="lucro-ultima">${empresa.lucro_ultimo_turno.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span></small>
                                </td>
                                <td class="text-center">
                                    <span class="badge ${statusClass} badge-status">
                                        <i class="bi bi-${statusIcon}"></i> ${statusText}
                                    </span>
                                </td>
                                <td class="text-center">${gapHtml}</td>
                                <td class="text-center">
                                    <span class="badge ${statusClass} badge-status">
                                        <i class="bi bi-${statusIcon}"></i> ${statusText}
                                    </span>
                                </td>
                                <td class="text-center">
                                    <div class="btn-group btn-group-sm mb-1" role="group">
                                        <button class="btn btn-outline-success" onclick="calcularOtimo('${empresa.nome}')" title="Calcular Solu√ß√£o √ìtima">
                                            <i class="bi bi-calculator"></i>
                                        </button>
                                        <button class="btn btn-success" onclick="aplicarOtimo('${empresa.nome}')" title="Aplicar Solu√ß√£o √ìtima">
                                            <i class="bi bi-lightning-fill"></i> √ìtimo
                                        </button>
                                    </div>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button class="btn btn-outline-primary" onclick="acessarComoEmpresa('${empresa.nome}')" title="Acessar como usu√°rio">
                                            <i class="bi bi-box-arrow-in-right"></i>
                                        </button>
                                        <button class="btn btn-outline-warning" onclick="alterarSenhaEmpresa('${empresa.nome}')" title="Alterar senha">
                                            <i class="bi bi-key"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="removerEmpresa('${empresa.nome}')" title="Remover">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                        statusTbody.append(rowStatus);
                    });
                }
            } else {
                // Apenas atualizar status de empresas existentes
                empresas.forEach(function(empresa, index) {
                    const row = $('tr[data-empresa="' + empresa.nome + '"]');
                    if (row.length) {
                        const statusBadge = row.find('.badge-status');
                        if (empresa.decisao_confirmada) {
                            statusBadge.removeClass('bg-warning').addClass('bg-success');
                            statusBadge.html('<i class="bi bi-check-circle"></i> Confirmada');
                        } else {
                            statusBadge.removeClass('bg-success').addClass('bg-warning');
                            statusBadge.html('<i class="bi bi-clock"></i> Pendente');
                        }
                        
                        // Atualizar lucro da √∫ltima itera√ß√£o
                        row.find('.lucro-ultima').text(empresa.lucro_ultimo_turno.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
                        
                        // Atualizar GAP%
                        if (empresa.gap_percentual != null) {
                            const gap = empresa.gap_percentual;
                            let bgColor = '#dc3545';  // Vermelho
                            if (gap <= 5) bgColor = '#28a745';  // Verde
                            else if (gap <= 20) bgColor = '#ffc107';  // Amarelo
                            
                            row.find('.gap-badge').css('background-color', bgColor);
                            row.find('.gap-valor').text(gap.toFixed(1) + '%');
                        }
                    }
                    
                    // Atualizar ranking
                    const rankingRow = $('#rankingTable tr').eq(index);
                    if (rankingRow.length) {
                        const lucroClass = empresa.lucro_ultimo_turno > 0 ? 'bg-success' : 'bg-danger';
                        rankingRow.find('td:eq(2)').html(`
                            <span class="badge ${lucroClass}">R$ ${empresa.lucro_ultimo_turno.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                        `);
                    }
                });
            }
        }).fail(function() {
            console.error('Erro ao atualizar lista de empresas');
        });
        
        // Atualizar tamb√©m o status geral do jogo
        $.get('/api/status', function(status) {
            if (status.iteracao_atual) {
                $('#iteracao-atual').text(status.iteracao_atual);
            }
            
            // Atualizar badge de status da itera√ß√£o
            atualizarControlesJogo(status);
        }).fail(function() {
            console.error('Erro ao atualizar status do jogo');
        });
    }
    
    // =============================================================================
    // GERENCIAMENTO DE SAVES
    // =============================================================================
    
    function salvarJogo() {
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
        const nomeDefault = `save_${timestamp}`;
        
        const nomeArquivo = prompt('Nome do save (deixe vazio para usar data/hora):', nomeDefault);
        
        if (nomeArquivo === null) return; // Cancelado
        
        showLoading();
        ajaxSeguro('/admin/api/saves/salvar', {
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ nome_arquivo: nomeArquivo || null })
        }).done(function(response) {
            hideLoading();
            if (response.sucesso) {
                const autoSaveAtivo = $('#autoSaveToggle').is(':checked');
                let mensagem = response.mensagem;
                if (autoSaveAtivo) {
                    mensagem += ' Auto-save ativado neste arquivo!';
                }
                showToast(mensagem, 'success');
                atualizarListaSaves();
            } else {
                showToast(response.mensagem, 'danger');
            }
        }).fail(function(xhr) {
            hideLoading();
            const msg = xhr.responseJSON?.mensagem || 'Erro ao salvar jogo';
            showToast(msg, 'danger');
        });
    }
    
    function atualizarListaSaves() {
        ajaxSeguro('/admin/api/saves/listar', {
            method: 'GET'
        }).done(function(response) {
            if (response.sucesso) {
                const saves = response.saves;
                $('#total-saves').text(saves.length);
                
                const tbody = $('#listaSaves');
                tbody.empty();
                
                if (saves.length === 0) {
                    tbody.append('<tr><td colspan="5" class="text-center text-muted">Nenhum save encontrado</td></tr>');
                } else {
                    saves.forEach(function(save) {
                        const dataSave = new Date(save.data_save).toLocaleString('pt-BR');
                        const tamanhoKB = (save.tamanho / 1024).toFixed(1);
                        
                        const row = `
                            <tr>
                                <td>
                                    <strong>${save.nome}</strong>
                                    <br><small class="text-muted">${tamanhoKB} KB</small>
                                </td>
                                <td>${dataSave}</td>
                                <td class="text-center">${save.total_empresas}</td>
                                <td class="text-center">${save.iteracao_atual}</td>
                                <td class="text-center">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button class="btn btn-success" onclick="carregarSave('${save.nome}')" title="Carregar">
                                            <i class="bi bi-folder-open"></i>
                                        </button>
                                        <button class="btn btn-info" onclick="downloadSave('${save.nome}')" title="Download">
                                            <i class="bi bi-download"></i>
                                        </button>
                                        <button class="btn btn-danger" onclick="excluirSave('${save.nome}')" title="Excluir">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                        tbody.append(row);
                    });
                }
            }
        }).fail(function() {
            console.error('Erro ao listar saves');
        });
    }
    
    function carregarSave(nomeArquivo) {
        const autoSaveAtivo = $('#autoSaveToggle').is(':checked');
        let confirmMsg = `Carregar o save "${nomeArquivo}"?\n\nO estado atual do jogo ser√° substitu√≠do!`;
        if (autoSaveAtivo) {
            confirmMsg += '\n\nAVISO: Auto-save est√° ativo e salvar√° neste arquivo!';
        }
        
        if (!confirm(confirmMsg)) {
            return;
        }
        
        showLoading();
        ajaxSeguro('/admin/api/saves/carregar', {
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ nome_arquivo: nomeArquivo })
        }).done(function(response) {
            hideLoading();
            if (response.sucesso) {
                let mensagem = response.mensagem;
                if (autoSaveAtivo) {
                    mensagem += ' Auto-save ativado!';
                }
                showToast(mensagem, 'success');
                $('#modalSaves').modal('hide');
                // Recarregar p√°gina para atualizar tudo
                setTimeout(function() {
                    window.location.reload();
                }, 1500);
            } else {
                showToast(response.mensagem, 'danger');
            }
        }).fail(function(xhr) {
            hideLoading();
            const msg = xhr.responseJSON?.mensagem || 'Erro ao carregar save';
            showToast(msg, 'danger');
        });
    }
    
    function downloadSave(nomeArquivo) {
        window.location.href = `/admin/api/saves/download/${encodeURIComponent(nomeArquivo)}`;
        showToast('Download iniciado!', 'info');
    }
    
    function excluirSave(nomeArquivo) {
        if (!confirm(`Excluir o save "${nomeArquivo}"?\n\nEsta a√ß√£o n√£o pode ser desfeita!`)) {
            return;
        }
        
        showLoading();
        ajaxSeguro('/admin/api/saves/excluir', {
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ nome_arquivo: nomeArquivo })
        }).done(function(response) {
            hideLoading();
            if (response.sucesso) {
                showToast(response.mensagem, 'success');
                atualizarListaSaves();
            } else {
                showToast(response.mensagem, 'danger');
            }
        }).fail(function(xhr) {
            hideLoading();
            const msg = xhr.responseJSON?.mensagem || 'Erro ao excluir save';
            showToast(msg, 'danger');
        });
    }
    
    function confirmarExcluirTodosSaves() {
        if (!confirm('Excluir TODOS os saves?\n\nEsta a√ß√£o n√£o pode ser desfeita!')) {
            return;
        }
        
        // Segunda confirma√ß√£o
        if (!confirm('Tem CERTEZA ABSOLUTA?\n\nTodos os saves ser√£o permanentemente exclu√≠dos!')) {
            return;
        }
        
        showLoading();
        ajaxSeguro('/admin/api/saves/excluir-todos', {
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ confirmar: true })
        }).done(function(response) {
            hideLoading();
            if (response.sucesso) {
                showToast(response.mensagem, 'success');
                atualizarListaSaves();
            } else {
                showToast(response.mensagem, 'danger');
            }
        }).fail(function(xhr) {
            hideLoading();
            const msg = xhr.responseJSON?.mensagem || 'Erro ao excluir saves';
            showToast(msg, 'danger');
        });
    }
    
    function uploadSave(input) {
        const arquivo = input.files[0];
        if (!arquivo) return;
        
        if (!arquivo.name.endsWith('.json')) {
            showToast('Apenas arquivos .json s√£o permitidos!', 'warning');
            input.value = '';
            return;
        }
        
        const formData = new FormData();
        formData.append('arquivo', arquivo);
        
        showLoading();
        
        // Obter CSRF token
        const csrfToken = $('meta[name="csrf-token"]').attr('content');
        
        $.ajax({
            url: '/admin/api/saves/upload',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            headers: {
                'X-CSRF-Token': csrfToken
            },
            success: function(response) {
                hideLoading();
                if (response.sucesso) {
                    showToast(response.mensagem, 'success');
                    atualizarListaSaves();
                } else {
                    showToast(response.mensagem, 'danger');
                }
                input.value = '';
            },
            error: function(xhr) {
                hideLoading();
                const response = xhr.responseJSON;
                
                // Verificar se √© erro de arquivo duplicado
                if (xhr.status === 409 && response?.arquivo_existe) {
                    // Arquivo j√° existe
                    showToast(response.mensagem + '\n\nüí° Dica: Renomeie o arquivo antes de fazer upload.', 'warning');
                } else {
                    // Outro erro
                    const msg = response?.mensagem || 'Erro ao enviar arquivo';
                    showToast(msg, 'danger');
                }
                input.value = '';
            }
        });
    }
    
    function toggleAutoSave() {
        const enabled = $('#autoSaveToggle').is(':checked');
        
        showLoading();
        ajaxSeguro('/admin/api/saves/auto-save/toggle', {
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ enabled: enabled })
        }).done(function(response) {
            hideLoading();
            if (response.sucesso) {
                showToast(response.mensagem, 'success');
            } else {
                showToast('Erro ao alterar auto-save', 'danger');
                // Reverter toggle se falhou
                $('#autoSaveToggle').prop('checked', !enabled);
            }
        }).fail(function(xhr) {
            hideLoading();
            const msg = xhr.responseJSON?.mensagem || 'Erro ao alterar auto-save';
            showToast(msg, 'danger');
            // Reverter toggle se falhou
            $('#autoSaveToggle').prop('checked', !enabled);
        });
    }
    
    function carregarStatusAutoSave() {
        ajaxSeguro('/admin/api/saves/auto-save/status', {
            method: 'GET'
        }).done(function(response) {
            if (response.sucesso) {
                $('#autoSaveToggle').prop('checked', response.auto_save_enabled);
            }
        }).fail(function() {
            console.error('Erro ao carregar status do auto-save');
        });
    }
    
    // ========================================
    // Gerador de Modelo Default (Otimizador Inverso)
    // ========================================
    
    let modeloGerado = null; // Armazenar resultado do modelo
    
    function gerarModeloDefault() {
        // Coletar produ√ß√£o esperada
        const producaoEsperada = {};
        {% for produto_key in produtos.keys() %}
        const qtd{{ loop.index }} = parseInt($('#producao-{{ produto_key }}').val()) || 0;
        if (qtd{{ loop.index }} > 0) {
            producaoEsperada['{{ produto_key }}'] = qtd{{ loop.index }};
        }
        {% endfor %}
        
        // Verificar se pelo menos um produto foi definido
        if (Object.keys(producaoEsperada).length === 0) {
            showToast('Defina pelo menos um produto com produ√ß√£o esperada!', 'warning');
            return;
        }
        
        // Coletar par√¢metros principais
        const parametrosPrincipais = {
            dinheiro: parseInt($('#param-dinheiro').val()) || 50000,
            materia_prima: parseInt($('#param-materia').val()) || 20000,
            energia: parseInt($('#param-energia').val()) || 15000,
            trabalhadores: parseInt($('#param-trabalhadores').val()) || 600
        };
        
        const aplicarPara = $('#aplicar-modelo-para').val();
        
        const dados = {
            producao_esperada: producaoEsperada,
            parametros_principais: parametrosPrincipais,
            aplicar_para: aplicarPara
        };
        
        showLoading();
        $('#btnGerarModelo').prop('disabled', true);
        
        ajaxSeguro('/admin/api/gerar-modelo-default', {
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(dados)
        }).done(function(response) {
            hideLoading();
            $('#btnGerarModelo').prop('disabled', false);
            
            if (response.sucesso) {
                modeloGerado = response.modelo;
                mostrarResultadoModelo(response);
                $('#btnAplicarModelo').prop('disabled', false);
                showToast('Modelo gerado com sucesso!', 'success');
            } else {
                showToast(response.mensagem || 'Erro ao gerar modelo', 'danger');
            }
        }).fail(function(xhr) {
            hideLoading();
            $('#btnGerarModelo').prop('disabled', false);
            const msg = xhr.responseJSON?.mensagem || 'Erro ao gerar modelo';
            showToast(msg, 'danger');
        });
    }
    
    function mostrarResultadoModelo(response) {
        const modelo = response.modelo;
        let html = `
            <div class="row">
                <div class="col-md-4">
                    <h6 class="text-success"><i class="bi bi-check-circle"></i> Recursos Otimizados:</h6>
                    <ul class="list-unstyled">
                        <li>üí∞ Dinheiro: <strong>R$ ${modelo.parametros_otimizados.dinheiro.toLocaleString()}</strong></li>
                        <li>üì¶ Mat√©ria-Prima: <strong>${modelo.parametros_otimizados.materia_prima.toLocaleString()}</strong></li>
                        <li>‚ö° Energia: <strong>${modelo.parametros_otimizados.energia.toLocaleString()}</strong></li>
                        <li>üë• Trabalhadores: <strong>${modelo.parametros_otimizados.trabalhadores}</strong></li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <h6 class="text-primary"><i class="bi bi-target"></i> Produ√ß√£o Fixa:</h6>
                    <ul class="list-unstyled">`;
        
        for (const [produto, qtd] of Object.entries(modelo.producao_fixa)) {
            html += `<li><strong>${produto}:</strong> ${qtd} unidades</li>`;
        }
        
        html += `
                    </ul>
                </div>
                <div class="col-md-4">
                    <h6 class="text-warning"><i class="bi bi-sliders"></i> Custos Otimizados:</h6>
                    <div style="max-height: 150px; overflow-y: auto;">`;
        
        if (modelo.custos_produtos_otimizados) {
            for (const [produto, custos] of Object.entries(modelo.custos_produtos_otimizados)) {
                html += `
                    <div class="mb-1">
                        <small><strong>${produto}:</strong></small><br>
                        <small class="text-muted">
                            üì¶${custos.consumo_materia} ‚ö°${custos.consumo_energia} üë•${custos.consumo_trabalhadores}
                        </small>
                    </div>`;
            }
        }
        
        html += `
                    </div>
                </div>
            </div>
            <div class="mt-2">
                <div class="row">
                    <div class="col-md-6">
                        <small class="text-success">
                            <strong>üí∞ Receita Esperada:</strong> R$ ${modelo.receita_esperada ? modelo.receita_esperada.toLocaleString() : 'N/A'}
                        </small>
                    </div>
                    <div class="col-md-6">
                        <small class="text-info">
                            <strong>üìà Lucro Esperado:</strong> R$ ${modelo.lucro_esperado ? modelo.lucro_esperado.toLocaleString() : 'N/A'}
                        </small>
                    </div>
                </div>
                <small class="text-muted">
                    <strong>Aplicar para:</strong> ${response.aplicar_para === 'todas' ? 'üåç Todas as Empresas' : 
                                                    response.aplicar_para === 'nova' ? 'üÜï Pr√≥ximas Empresas' : 
                                                    'üè¢ ' + response.aplicar_para}
                </small>
            </div>`;
        
        $('#detalhes-modelo').html(html);
        $('#resultado-modelo').slideDown();
    }
    
    function aplicarModeloDefault() {
        if (!modeloGerado) {
            showToast('Gere um modelo primeiro!', 'warning');
            return;
        }
        
        const aplicarPara = $('#aplicar-modelo-para').val();
        
        showLoading();
        $('#btnAplicarModelo').prop('disabled', true);
        
        ajaxSeguro('/admin/api/aplicar-modelo-default', {
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                modelo: modeloGerado,
                aplicar_para: aplicarPara
            })
        }).done(function(response) {
            hideLoading();
            $('#btnAplicarModelo').prop('disabled', false);
            
            if (response.sucesso) {
                showToast(response.mensagem, 'success');
                atualizarDashboard(); // Refresh do dashboard
                limparModelo(); // Limpar formul√°rio
            } else {
                showToast(response.mensagem || 'Erro ao aplicar modelo', 'danger');
            }
        }).fail(function(xhr) {
            hideLoading();
            $('#btnAplicarModelo').prop('disabled', false);
            const msg = xhr.responseJSON?.mensagem || 'Erro ao aplicar modelo';
            showToast(msg, 'danger');
        });
    }
    
    function limparModelo() {
        // Limpar produ√ß√£o esperada
        {% for produto_key in produtos.keys() %}
        $('#producao-{{ produto_key }}').val(0);
        {% endfor %}
        
        // Resetar par√¢metros para valores padr√£o
        $('#param-dinheiro').val({{ recursos_base.dinheiro }});
        $('#param-materia').val({{ recursos_base.materia_prima }});
        $('#param-energia').val({{ recursos_base.energia }});
        $('#param-trabalhadores').val({{ recursos_base.trabalhadores }});
        
        // Resetar sele√ß√£o
        $('#aplicar-modelo-para').val('nova');
        
        // Ocultar resultado
        $('#resultado-modelo').slideUp();
        $('#btnAplicarModelo').prop('disabled', true);
        
        // Limpar modelo armazenado
        modeloGerado = null;
    }
    
    // ========================================
    
    // Inicializar
    $(document).ready(function() {
        inicializarGrafico();
        atualizarListaSaves(); // Carregar lista de saves
        carregarStatusAutoSave(); // Carregar status do auto-save
        
        // Auto-refresh gr√°fico a cada 30 segundos
        setInterval(atualizarGrafico, 30000);
        
        // Auto-refresh lista de empresas a cada 3 segundos
        setInterval(atualizarListaEmpresas, 3000);
        
        // Atualizar lista de saves quando o modal for aberto
        $('#modalSaves').on('show.bs.modal', function() {
            atualizarListaSaves();
        });
    });
    
    // Fun√ß√£o para mostrar modal do modelo matem√°tico
    function mostrarModeloMatematico() {
        $('#modalModeloMatematico').modal('show');
    }
    
    // Alternar entre modelo gen√©rico e com valores
    function alternarModeloTipo() {
        const tipoModelo = $('input[name="tipoModelo"]:checked').val();
        if (tipoModelo === 'generico') {
            $('#modelo-generico').show();
            $('#modelo-valores').hide();
        } else {
            $('#modelo-generico').hide();
            $('#modelo-valores').show();
        }
    }
    
    // Fun√ß√£o para mostrar modal do tutorial
    function mostrarTutorial() {
        $('#modalTutorial').modal('show');
    }
    
    // =========================================================================
    // TIMER DE RODADA
    // =========================================================================
    let timerInterval = null;
    let timerSeconds = 0;
    let timerPausado = false;
    
    function mostrarTimer() {
        $('#modalTimer').modal('show');
    }
    
    function formatarTempo(segundos) {
        const horas = Math.floor(segundos / 3600);
        const minutos = Math.floor((segundos % 3600) / 60);
        const segs = segundos % 60;
        
        if (horas > 0) {
            return `${horas.toString().padStart(2, '0')}:${minutos.toString().padStart(2, '0')}:${segs.toString().padStart(2, '0')}`;
        } else {
            return `${minutos.toString().padStart(2, '0')}:${segs.toString().padStart(2, '0')}`;
        }
    }
    
    function atualizarDisplayTimer() {
        $('#timer-display').text(formatarTempo(timerSeconds));
        
        // Atualizar cor baseado no tempo restante
        const display = $('#timer-display');
        if (timerSeconds <= 60) {
            display.removeClass('text-warning text-success').addClass('text-danger');
        } else if (timerSeconds <= 300) {
            display.removeClass('text-danger text-success').addClass('text-warning');
        } else {
            display.removeClass('text-danger text-warning').addClass('text-success');
        }
    }
    
    function iniciarTimer() {
        if (timerSeconds === 0) {
            // Timer zerado, pedir tempo inicial
            const minutos = parseInt(prompt('Quantos minutos deseja definir?', '5'));
            if (minutos && minutos > 0) {
                timerSeconds = minutos * 60;
            } else {
                return;
            }
        }
        
        timerPausado = false;
        $('#btn-iniciar-timer').prop('disabled', true);
        $('#btn-pausar-timer').prop('disabled', false);
        
        if (timerInterval) clearInterval(timerInterval);
        
        timerInterval = setInterval(() => {
            if (!timerPausado) {
                timerSeconds--;
                atualizarDisplayTimer();
                
                // Alertas sonoros nos √∫ltimos segundos
                if (timerSeconds === 60) {
                    mostrarAlertaTimer('‚ö†Ô∏è 1 minuto restante!', 'warning');
                } else if (timerSeconds === 30) {
                    mostrarAlertaTimer('‚ö†Ô∏è 30 segundos restantes!', 'warning');
                } else if (timerSeconds === 10) {
                    mostrarAlertaTimer('üö® 10 segundos!', 'danger');
                }
                
                if (timerSeconds <= 0) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                    mostrarAlertaTimer('‚è∞ TEMPO ESGOTADO!', 'danger');
                    $('#btn-iniciar-timer').prop('disabled', false);
                    $('#btn-pausar-timer').prop('disabled', true);
                }
            }
        }, 1000);
    }
    
    function pausarTimer() {
        timerPausado = true;
        $('#btn-iniciar-timer').prop('disabled', false);
        $('#btn-pausar-timer').prop('disabled', true);
    }
    
    function resetarTimer() {
        if (confirm('Resetar o timer?')) {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            timerSeconds = 0;
            timerPausado = false;
            atualizarDisplayTimer();
            $('#btn-iniciar-timer').prop('disabled', false);
            $('#btn-pausar-timer').prop('disabled', true);
            $('#timer-alertas').empty();
        }
    }
    
    function adicionarTempo(minutos) {
        timerSeconds += minutos * 60;
        atualizarDisplayTimer();
        mostrarAlertaTimer(`‚ûï Adicionados ${minutos} minuto(s)`, 'info');
    }
    
    function mostrarAlertaTimer(mensagem, tipo) {
        const alertas = $('#timer-alertas');
        const alerta = $(`
            <div class="alert alert-${tipo} alert-dismissible fade show mb-2" role="alert">
                ${mensagem}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `);
        alertas.prepend(alerta);
        
        // Auto-remover ap√≥s 5 segundos
        setTimeout(() => {
            alerta.fadeOut(() => alerta.remove());
        }, 5000);
    }
</script>

<!-- Modal Timer -->
<div class="modal fade" id="modalTimer" tabindex="-1" aria-labelledby="modalTimerLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="modalTimerLabel">
                    <i class="bi bi-stopwatch"></i> Timer de Rodada
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <!-- Display do Timer -->
                <div class="mb-4 p-5" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 20px;">
                    <div id="timer-display" class="display-1 fw-bold text-white" style="font-size: 6rem; text-shadow: 0 4px 6px rgba(0,0,0,0.3);">
                        00:00
                    </div>
                    <p class="text-white-50 mt-2 mb-0">Tempo da Rodada</p>
                </div>
                
                <!-- Controles Principais -->
                <div class="d-grid gap-3 mb-4">
                    <div class="row g-2">
                        <div class="col-4">
                            <button id="btn-iniciar-timer" class="btn btn-success btn-lg w-100" onclick="iniciarTimer()">
                                <i class="bi bi-play-fill"></i><br>
                                <small>INICIAR</small>
                            </button>
                        </div>
                        <div class="col-4">
                            <button id="btn-pausar-timer" class="btn btn-warning btn-lg w-100" onclick="pausarTimer()" disabled>
                                <i class="bi bi-pause-fill"></i><br>
                                <small>PAUSAR</small>
                            </button>
                        </div>
                        <div class="col-4">
                            <button class="btn btn-danger btn-lg w-100" onclick="resetarTimer()">
                                <i class="bi bi-arrow-counterclockwise"></i><br>
                                <small>RESETAR</small>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Adicionar Tempo -->
                <div class="card bg-light mb-3">
                    <div class="card-body">
                        <h6 class="card-title mb-3"><i class="bi bi-plus-circle"></i> Adicionar Tempo</h6>
                        <div class="btn-group w-100" role="group">
                            <button class="btn btn-outline-primary" onclick="adicionarTempo(1)">
                                <i class="bi bi-plus"></i> 1 min
                            </button>
                            <button class="btn btn-outline-primary" onclick="adicionarTempo(5)">
                                <i class="bi bi-plus"></i> 5 min
                            </button>
                            <button class="btn btn-outline-primary" onclick="adicionarTempo(10)">
                                <i class="bi bi-plus"></i> 10 min
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Alertas -->
                <div id="timer-alertas"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Tutorial -->
<div class="modal fade" id="modalTutorial" tabindex="-1" aria-labelledby="modalTutorialLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="modalTutorialLabel">
                    <i class="bi bi-question-circle"></i> Como Funciona o Jogo - Guia para Professores
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                {% include 'partials/tutorial.html' %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Modelo Matem√°tico -->
<div class="modal fade" id="modalModeloMatematico" tabindex="-1" aria-labelledby="modalModeloLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalModeloLabel">
                    <i class="bi bi-calculator"></i> Modelo Matem√°tico de Otimiza√ß√£o
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Altern√¢ncia entre gen√©rico e com valores -->
                <div class="btn-group mb-4" role="group">
                    <input type="radio" class="btn-check" name="tipoModelo" id="radioGenerico" value="generico" checked onchange="alternarModeloTipo()">
                    <label class="btn btn-outline-primary" for="radioGenerico">
                        <i class="bi bi-book"></i> Modelo Gen√©rico
                    </label>
                    
                    <input type="radio" class="btn-check" name="tipoModelo" id="radioValores" value="valores" onchange="alternarModeloTipo()">
                    <label class="btn btn-outline-success" for="radioValores">
                        <i class="bi bi-123"></i> Com Valores Reais
                    </label>
                </div>
                
                {% include 'partials/modelo_matematico.html' %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}
